<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0071e3;          /* Apple-esque blue */
  --secondary-color: #5e5ce6;        /* Soft complementary accent */
  --success-color: #28c76f;          /* Fresh green */
  --warning-color: #ff9f43;          /* Warm gold */
  --danger-color: #ff375f;           /* Subtle vibrant red */

  /* Backgrounds */
  --bg-primary: #f5f5f7;             /* Very light off-white (like macOS backgrounds) */
  --bg-secondary: #e9e9e9;           /* Pure white for cards/panels */
  --bg-tertiary: #f0f2f7;            /* Slightly tinted for nested sections */

  /* Text */
  --text-primary: #1d1f27;           /* Dark charcoal, not pure black */
  --text-secondary: #6e7280;         /* Soft gray for secondary text */
  --text-muted: #9aa0b1;             /* Muted captions / placeholders */

  /* Borders and surfaces */
  --border-color: rgba(0, 0, 0, 0.08);   /* Very subtle border */
  --card-bg: #ffffff;
  --input-bg: #d9e4ff;
  --input-border: rgba(0, 0, 0, 0.1);
  --hover-bg: rgba(0, 113, 227, 0.06);   /* Light primary hover shimmer */

        }

        body {
            background: var(--bg-primary);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }

        .main-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: 1rem;
            max-width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-radius: 16px 16px 0 0;
        }

        @media (min-width: 768px) {
            .main-container {
                margin: 2rem auto;
                max-width: 1400px;
            }
            
            .header {
                padding: 2.5rem;
                border-radius: 24px 24px 0 0;
            }
        }

        .content-section {
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .content-section {
                padding: 2rem;
            }
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 768px) {
            .stats-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 1.5rem;
                border-radius: 16px;
            }
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        @media (min-width: 768px) {
            .stat-number {
                font-size: 2rem;
            }
        }

        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .table-container {
                border-radius: 16px;
                margin-bottom: 2rem;
            }
        }

        .table-header {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .table-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 1.5rem;
            }
        }

        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .btn {
                border-radius: 12px;
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .action-buttons {
                justify-content: flex-end;
                gap: 1rem;
            }
        }

        /* Table Styles */
        .table {
            margin-bottom: 0;
            color: var(--text-primary);
        }

        .table th {
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-color);
            padding: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .table td {
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem;
            font-size: 0.875rem;
            vertical-align: middle;
        }

        @media (min-width: 768px) {
            .table th,
            .table td {
                padding: 1rem;
                font-size: 1rem;
            }
        }

        .table tbody tr:hover {
            background: var(--hover-bg);
        }

        /* Form Styles */
        .form-control,
        .form-select {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .form-control:focus,
        .form-select:focus {
            background: var(--input-bg);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-label {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* Modal Styles */
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
        }

        /* Filters Section */
        .filters-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        @media (min-width: 768px) {
            .filters-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                border-radius: 16px;
            }
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -3px rgba(99, 102, 241, 0.4);
        }

        .table th {
            background: #f8fafc;
            border: none;
            padding: 1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .table td {
            border: none;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .status-select {
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            padding: 0.5rem;
            font-weight: 600;
        }

        .status-applied { color: #1e40af; }
        .status-interviewing { color: #92400e; }
        .status-offer { color: #065f46; }
        .status-rejected { color: #991b1b; }
        .status-withdrawn { color: #374151; }

        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
            border: none;
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem 1rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .editable-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .editable-select select {
            padding-right: 2rem;
            width: 100%;
        }

        .editable-select .add-option-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .editable-select .custom-input {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 0.5rem;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            display: none;
            margin-top: 2px;
        }

        .editable-select .custom-input input {
            width: 100%;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 0.9rem;
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .editable-select .custom-input input:focus {
            background: var(--input-bg);
            color: var(--text-primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .editable-select .custom-input input {
            width: 100%;
            border: none;
            outline: none;
            padding: 0.25rem;
            font-size: 0.9rem;
        }

        .editable-select .custom-input .input-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .editable-select .custom-input .input-buttons button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .editable-select .option-with-delete {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0.5rem;
        }

        .editable-select .option-with-delete .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.7rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .editable-select .option-with-delete .delete-btn:hover {
            opacity: 1;
            background: #fee2e2;
        }

        .editable-select .option-with-delete .delete-btn:focus {
            outline: none;
        }

        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .custom-dropdown .dropdown-toggle {
            width: 100%;
            text-align: left;
            position: relative;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .custom-dropdown .dropdown-toggle {
                border-radius: 12px;
            }
        }

        .custom-dropdown .dropdown-toggle:hover {
            border-color: var(--primary-color);
        }

        .custom-dropdown .dropdown-toggle:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .custom-dropdown .dropdown-toggle::after {
            content: '';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #6b7280;
        }

        .custom-dropdown .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 2px;
        }

        .custom-dropdown .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .custom-dropdown .dropdown-item:last-child {
            border-bottom: none;
        }

        .custom-dropdown .dropdown-item:hover {
            background-color: var(--hover-bg);
        }

        .custom-dropdown .dropdown-item.custom-option {
            color: var(--primary-color);
            font-weight: 600;
        }

        .custom-dropdown .dropdown-item.custom-option:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .search-highlight {
            background: #fef3c7;
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }

        @media (max-width: 768px) {
            .toast-container {
                top: 0.5rem;
                right: 0.5rem;
                left: 0.5rem;
            }
        }

        .toast {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.3);
            border: none;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        /* Mobile Responsive Table */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 0.5rem;
                word-wrap: break-word;
            }
            
            .btn-group-sm .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">


                <div class="content-section">
                <!-- Vercel Notice -->
                <div class="alert alert-info" id="vercelNotice" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Vercel Deployment Notice:</strong> This is running on Vercel's serverless environment. 
                    Data will be stored in memory and will be lost when the function restarts. 
                    For persistent storage, consider using a database or local deployment.
                </div>
                
                <div class="stats-cards" id="statsCards">
                    <div class="stat-card">
                        <div class="stat-number" id="totalApplications">0</div>
                        <div class="stat-label">Total Applications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recentApplications">0</div>
                        <div class="stat-label">Recent (30 days)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="interviewingCount">0</div>
                        <div class="stat-label">Interviewing</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="offerCount">0</div>
                        <div class="stat-label">Offers</div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <h5 class="mb-3"><i class="fas fa-filter"></i> Search & Filters</h5>
                    <div class="row">
                        <div class="col-12 col-md-6 col-lg-3 mb-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search in all fields...">
                        </div>
                        <div class="col-6 col-md-3 col-lg-2 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Statuses</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2 mb-3">
                            <label class="form-label">Platform</label>
                            <select class="form-select" id="platformFilter">
                                <option value="">All Platforms</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-6 col-lg-2 mb-3">
                            <label class="form-label">Date From</label>
                            <input type="date" class="form-control" id="dateFromFilter">
                        </div>
                        <div class="col-6 col-md-6 col-lg-2 mb-3">
                            <label class="form-label">Date To</label>
                            <input type="date" class="form-control" id="dateToFilter">
                        </div>
                        <div class="col-12 col-lg-1 mb-3 d-flex align-items-end justify-content-center">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">
                            <i class="fas fa-table"></i> Job Applications
                        </h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="openAddJobModal()">
                                <i class="fas fa-plus"></i> Add Job
                            </button>
                            <button class="btn btn-outline-primary" onclick="openAddColumnModal()">
                                <i class="fas fa-plus"></i> Add Column
                            </button>
                            <button class="btn btn-outline-warning" onclick="resetColumns()" title="Reset to default columns">
                                <i class="fas fa-undo"></i> Reset Columns
                            </button>
                            <button class="btn btn-outline-info" onclick="initColumns()" title="Initialize default columns">
                                <i class="fas fa-magic"></i> Init Columns
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearAllData()" title="Clear all jobs and reset">
                                <i class="fas fa-trash-alt"></i> Clear All Data
                            </button>
                            <button class="btn btn-outline-secondary" onclick="forceRefreshData()" title="Force refresh data from server">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                            <button class="btn btn-outline-primary" onclick="syncData()" title="Sync data from file to memory">
                                <i class="fas fa-database"></i> Sync Data
                            </button>
                            <button class="btn btn-outline-info" onclick="showStorageStatus()" title="Show current storage status">
                                <i class="fas fa-info-circle"></i> Storage Status
                            </button>
                            
                            <button class="btn btn-warning" id="bulkUpdateBtn" onclick="openBulkUpdateModal()" style="display: none;">
                                <i class="fas fa-edit"></i> Bulk Update (<span id="selectedCount">0</span>)
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button class="btn btn-outline-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-outline-info" onclick="sendEmailReminder()">
                                <i class="fas fa-envelope"></i> Send Email
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table" id="jobsTable">
                            <thead id="tableHeader">
                                <!-- Dynamic headers will be loaded here -->
                            </thead>
                            <tbody id="jobsTableBody">
                                <!-- Jobs will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <h4>No job applications yet</h4>
                        <p>Start tracking your job applications by adding your first entry.</p>
                        <button class="btn btn-primary" onclick="openAddJobModal()">
                            <i class="fas fa-plus"></i> Add Your First Job
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Job Modal -->
    <div class="modal fade" id="jobModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fas fa-plus"></i> Add New Job Application
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="jobForm">
                        <input type="hidden" id="jobId">
                        <div id="jobFormFields">
                            <!-- Dynamic form fields will be loaded here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveJob()">
                        <i class="fas fa-save"></i> Save Job
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div class="modal fade" id="columnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-columns"></i> Add New Column
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="columnForm">
                        <div class="mb-3">
                            <label for="columnName" class="form-label">Column Name *</label>
                            <input type="text" class="form-control" id="columnName" required>
                        </div>
                        <div class="mb-3">
                            <label for="columnType" class="form-label">Field Type *</label>
                            <select class="form-select" id="columnType" required onchange="toggleColumnOptions()">
                                <option value="">Select Type</option>
                                <option value="text">Text</option>
                                <option value="textarea">Text Area</option>
                                <option value="select">Dropdown</option>
                                <option value="date">Date</option>
                                <option value="url">URL</option>
                                <option value="number">Number</option>
                            </select>
                        </div>
                        <div class="mb-3" id="selectOptionsDiv" style="display: none;">
                            <label for="selectOptions" class="form-label">Options (one per line)</label>
                            <textarea class="form-control" id="selectOptions" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="columnRequired">
                                <label class="form-check-label" for="columnRequired">
                                    Required Field
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveColumn()">
                        <i class="fas fa-save"></i> Add Column
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Option Modal -->
    <div class="modal fade" id="optionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus"></i> Add New Option
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newOption" class="form-label">New Option</label>
                        <input type="text" class="form-control" id="newOption" placeholder="Enter new option...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addOption()">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Update Modal -->
    <div class="modal fade" id="bulkUpdateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit"></i> Bulk Update Jobs (<span id="bulkUpdateCount">0</span> selected)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Bulk Update:</strong> Update multiple fields for all selected jobs at once. Leave fields empty to keep current values.
                    </div>
                    
                    <form id="bulkUpdateForm">
                        <div class="row" id="bulkUpdateFields">
                            <!-- Dynamic fields will be generated here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="bulkDeleteJobs()">
                        <i class="fas fa-trash"></i> Delete All Selected
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveBulkUpdate()">
                        <i class="fas fa-save"></i> Update All Jobs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let jobs = [];
        let columns = [];
        let currentField = null;
        let searchTimeout = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadColumns();
            setupEventListeners();
            checkEnvironmentInfo();
        });

        function setupEventListeners() {
            // Search with debouncing
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadJobs();
                }, 300);
            });

            // Filter changes
            document.getElementById('statusFilter').addEventListener('change', loadJobs);
            document.getElementById('platformFilter').addEventListener('change', loadJobs);
            document.getElementById('dateFromFilter').addEventListener('change', loadJobs);
            document.getElementById('dateToFilter').addEventListener('change', loadJobs);

            // Click outside to close custom inputs and dropdowns
            document.addEventListener('click', function(event) {
                // Close custom inputs
                const customInputs = document.querySelectorAll('.custom-input');
                customInputs.forEach(input => {
                    if (!input.contains(event.target) && !event.target.closest('.editable-select')) {
                        input.style.display = 'none';
                    }
                });
                
                // Close dropdowns
                if (!event.target.closest('.custom-dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                }
            });
        }

        async function loadColumns() {
            try {
                const response = await fetch('/api/columns');
                columns = await response.json();
                console.log('Debug: Loaded columns:', columns);
                
                // If no columns are found, try to initialize them
                if (!columns || columns.length === 0) {
                    console.log('No columns found, initializing defaults...');
                    await initColumns();
                    return; // initColumns will call loadColumns again
                }
                
                displayTable();
                populateFiltersFromColumns(); // Initial population from column config
                await loadJobs();
                loadStats();
            } catch (error) {
                console.error('Error loading columns:', error);
                showToast('Error loading columns', 'error');
            }
        }

        function populateFiltersFromColumns() {
            const statusFilter = document.getElementById('statusFilter');
            const platformFilter = document.getElementById('platformFilter');
            
            // Clear existing options (keep the default "All" options)
            statusFilter.innerHTML = '<option value="">All Statuses</option>';
            platformFilter.innerHTML = '<option value="">All Platforms</option>';
            
            // Get options from column configuration
            const statusColumn = columns.find(col => col.id === 'status');
            const platformColumn = columns.find(col => col.id === 'platform');
            
            if (statusColumn && statusColumn.options) {
                statusColumn.options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    statusFilter.appendChild(optionElement);
                });
            }
            
            if (platformColumn && platformColumn.options) {
                platformColumn.options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    platformFilter.appendChild(optionElement);
                });
            }
        }

        function displayTable() {
            const thead = document.getElementById('tableHeader');
            thead.innerHTML = '';

            // Add checkbox column header
            const checkboxTh = document.createElement('th');
            checkboxTh.className = 'text-center';
            checkboxTh.innerHTML = `
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" title="Select All">
            `;
            thead.appendChild(checkboxTh);

            // Add headers for each column
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column.name;
                thead.appendChild(th);
            });

            // Add actions column
            const actionsTh = document.createElement('th');
            actionsTh.textContent = 'Actions';
            thead.appendChild(actionsTh);
        }

        async function loadJobs() {
            try {
                const search = document.getElementById('searchInput').value;
                const status = document.getElementById('statusFilter').value;
                const platform = document.getElementById('platformFilter').value;
                const dateFrom = document.getElementById('dateFromFilter').value;
                const dateTo = document.getElementById('dateToFilter').value;

                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (status) params.append('status', status);
                if (platform) params.append('platform', platform);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);

                const response = await fetch(`/api/jobs?${params}`);
                jobs = await response.json();
                displayJobs();
                loadStats();
                populateFilters();
            } catch (error) {
                console.error('Error loading jobs:', error);
                showToast('Error loading jobs', 'error');
            }
        }

        function displayJobs() {
            const tbody = document.getElementById('jobsTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('jobsTable');

            if (jobs.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            table.style.display = 'table';
            tbody.innerHTML = '';

            jobs.forEach(job => {
                const row = createJobRow(job);
                tbody.appendChild(row);
            });
        }

        function createJobRow(job) {
            const row = document.createElement('tr');
            
            // Add checkbox cell
            const checkboxTd = document.createElement('td');
            checkboxTd.className = 'text-center';
            checkboxTd.innerHTML = `
                <input type="checkbox" class="job-checkbox" value="${job.id}" onchange="updateSelectedCount()">
            `;
            row.appendChild(checkboxTd);
            
            // Add cells for each column
            columns.forEach(column => {
                const td = document.createElement('td');
                const value = job[column.id] || '';
                
                if (column.type === 'select') {
                    td.innerHTML = createSelectCell(column, value, job.id);
                } else if (column.type === 'url' && value) {
                    td.innerHTML = `<a href="${value}" target="_blank">${value}</a>`;
                } else if (column.type === 'date' && value) {
                    td.innerHTML = formatDate(value);
                } else {
                    td.innerHTML = highlightSearch(value);
                }
                
                row.appendChild(td);
            });

            // Add actions cell
            const actionsTd = document.createElement('td');
            actionsTd.innerHTML = `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editJob('${job.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteJob('${job.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            row.appendChild(actionsTd);

            return row;
        }

        function createSelectCell(column, value, jobId) {
            const options = column.options || [];
            let optionsHtml = '';
            
            options.forEach(option => {
                const selected = option === value ? 'selected' : '';
                optionsHtml += `<option value="${option}" ${selected}>${option}</option>`;
            });

            const selectClass = column.id === 'status' ? 'status-select' : '';
            const statusClass = column.id === 'status' ? getStatusClass(value) : '';

            return `
                <div class="editable-select">
                    <select class="form-select ${selectClass} ${statusClass}" onchange="handleSelectChange(this, '${column.id}', '${jobId}')">
                        <option value="">Select ${column.name}</option>
                        ${optionsHtml}
                        <option value="__custom__">+ Add Custom Option</option>
                    </select>
                    <div class="custom-input" id="custom-input-${column.id}-${jobId}">
                        <input type="text" placeholder="Type your custom option..." onkeypress="handleCustomInputKeypress(event, '${column.id}', '${jobId}')">
                        <div class="input-buttons">
                            <button class="btn btn-sm btn-primary" onclick="addCustomOption('${column.id}', '${jobId}')">Add</button>
                            <button class="btn btn-sm btn-secondary" onclick="hideCustomInput('${column.id}', '${jobId}')">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Applied': return 'status-applied';
                case 'Interviewing': return 'status-interviewing';
                case 'Offer': return 'status-offer';
                case 'Rejected': return 'status-rejected';
                case 'Withdrawn': return 'status-withdrawn';
                default: return '';
            }
        }

        function highlightSearch(text) {
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (!search) return escapeHtml(text);
            
            const regex = new RegExp(`(${search})`, 'gi');
            return escapeHtml(text).replace(regex, '<span class="search-highlight">$1</span>');
        }

        function populateFilters() {
            const statusFilter = document.getElementById('statusFilter');
            const platformFilter = document.getElementById('platformFilter');
            
            // Store current selected values
            const currentStatus = statusFilter.value;
            const currentPlatform = platformFilter.value;
            
            // Clear existing options (keep the default "All" options)
            statusFilter.innerHTML = '<option value="">All Statuses</option>';
            platformFilter.innerHTML = '<option value="">All Platforms</option>';
            
            // Get unique values from jobs
            const statuses = [...new Set(jobs.map(job => job.status).filter(Boolean))];
            const platforms = [...new Set(jobs.map(job => job.platform).filter(Boolean))];
            
            // Also get options from column configuration for initial population
            const statusColumn = columns.find(col => col.id === 'status');
            const platformColumn = columns.find(col => col.id === 'platform');
            
            if (statusColumn && statusColumn.options) {
                statusColumn.options.forEach(option => {
                    if (!statuses.includes(option)) {
                        statuses.push(option);
                    }
                });
            }
            
            if (platformColumn && platformColumn.options) {
                platformColumn.options.forEach(option => {
                    if (!platforms.includes(option)) {
                        platforms.push(option);
                    }
                });
            }
            
            // Populate status filter
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });
            
            // Populate platform filter
            platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = platform;
                platformFilter.appendChild(option);
            });
            
            // Restore selected values if they still exist
            if (currentStatus && statuses.includes(currentStatus)) {
                statusFilter.value = currentStatus;
            }
            if (currentPlatform && platforms.includes(currentPlatform)) {
                platformFilter.value = currentPlatform;
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('platformFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            loadJobs();
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('totalApplications').textContent = stats.total_applications;
                document.getElementById('recentApplications').textContent = stats.recent_applications;
                
                const interviewingCount = stats.status_breakdown['Interviewing'] || 0;
                const offerCount = stats.status_breakdown['Offer'] || 0;
                
                document.getElementById('interviewingCount').textContent = interviewingCount;
                document.getElementById('offerCount').textContent = offerCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function openAddJobModal() {
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus"></i> Add New Job Application';
            document.getElementById('jobForm').reset();
            document.getElementById('jobId').value = '';
            createJobForm();
            
            const modal = new bootstrap.Modal(document.getElementById('jobModal'));
            modal.show();
        }

        function createJobForm() {
            const formFields = document.getElementById('jobFormFields');
            formFields.innerHTML = '';
            
            console.log('Debug: Creating form with columns:', columns);

            // If no columns are configured, show a message
            if (!columns || columns.length === 0) {
                formFields.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>No columns configured.</strong> Please add columns first or click "Init Columns" to use defaults.
                    </div>
                `;
                return;
            }

            columns.forEach(column => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'mb-3';
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.htmlFor = column.id;
                label.textContent = column.name;
                if (column.required) {
                    label.innerHTML += ' *';
                }
                
                fieldDiv.appendChild(label);
                
                if (column.type === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.className = 'form-control';
                    textarea.id = column.id;
                    textarea.rows = 3;
                    textarea.placeholder = `Enter ${column.name.toLowerCase()}`;
                    if (column.required) textarea.required = true;
                    fieldDiv.appendChild(textarea);
                } else if (column.type === 'select') {
                    const selectDiv = document.createElement('div');
                    selectDiv.className = 'editable-select';
                    
                    // Create custom dropdown container
                    const dropdownContainer = document.createElement('div');
                    dropdownContainer.className = 'custom-dropdown';
                    dropdownContainer.id = `dropdown-${column.id}`;
                    
                    // Create the main button
                    const dropdownButton = document.createElement('button');
                    dropdownButton.type = 'button';
                    dropdownButton.className = 'form-select dropdown-toggle';
                    dropdownButton.id = `${column.id}-button`;
                    dropdownButton.textContent = `Select ${column.name}`;
                    dropdownButton.onclick = function() {
                        toggleDropdown(column.id);
                    };
                    
                    // Create hidden input for form submission
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = column.id;
                    hiddenInput.name = column.id;
                    if (column.required) hiddenInput.required = true;
                    
                    // Create dropdown menu
                    const dropdownMenu = document.createElement('div');
                    dropdownMenu.className = 'dropdown-menu';
                    dropdownMenu.id = `menu-${column.id}`;
                    dropdownMenu.style.display = 'none';
                    
                    // Add default option
                    const defaultOption = document.createElement('div');
                    defaultOption.className = 'dropdown-item';
                    defaultOption.textContent = `Select ${column.name}`;
                    defaultOption.onclick = function() {
                        selectOption(column.id, '', `Select ${column.name}`);
                    };
                    dropdownMenu.appendChild(defaultOption);
                    
                    // Add existing options with delete buttons
                    column.options.forEach(option => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'dropdown-item option-with-delete';
                        optionDiv.innerHTML = `
                            <span>${option}</span>
                            <button class="delete-btn" onclick="deleteOption('${column.id}', '${option}', event)" title="Delete option">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        optionDiv.onclick = function(e) {
                            if (!e.target.closest('.delete-btn')) {
                                selectOption(column.id, option, option);
                            }
                        };
                        dropdownMenu.appendChild(optionDiv);
                    });
                    
                    // Add custom option
                    const customOption = document.createElement('div');
                    customOption.className = 'dropdown-item custom-option';
                    customOption.innerHTML = '<i class="fas fa-plus"></i> Add Custom Option';
                    customOption.onclick = function() {
                        showCustomInputForm(null, column.id);
                    };
                    dropdownMenu.appendChild(customOption);
                    
                    dropdownContainer.appendChild(dropdownButton);
                    dropdownContainer.appendChild(hiddenInput);
                    dropdownContainer.appendChild(dropdownMenu);
                    
                    // Add custom input for form
                    const customInputDiv = document.createElement('div');
                    customInputDiv.className = 'custom-input';
                    customInputDiv.id = `custom-input-form-${column.id}`;
                    customInputDiv.innerHTML = `
                        <input type="text" placeholder="Type your custom option..." onkeypress="handleCustomInputFormKeypress(event, '${column.id}')">
                        <div class="input-buttons">
                            <button type="button" class="btn btn-sm btn-primary" onclick="addCustomOptionForm('${column.id}')">Add</button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="hideCustomInputForm('${column.id}')">Cancel</button>
                        </div>
                    `;
                    dropdownContainer.appendChild(customInputDiv);
                    
                    selectDiv.appendChild(dropdownContainer);
                    fieldDiv.appendChild(selectDiv);
                } else if (column.type === 'date') {
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.className = 'form-control';
                    input.id = column.id;
                    if (column.required) input.required = true;
                    if (column.id === 'application_date') {
                        input.value = new Date().toISOString().split('T')[0];
                    }
                    fieldDiv.appendChild(input);
                } else if (column.type === 'url') {
                    const input = document.createElement('input');
                    input.type = 'url';
                    input.className = 'form-control';
                    input.id = column.id;
                    input.placeholder = column.placeholder || 'https://example.com';
                    if (column.required) input.required = true;
                    fieldDiv.appendChild(input);
                } else if (column.type === 'number') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control';
                    input.id = column.id;
                    if (column.required) input.required = true;
                    fieldDiv.appendChild(input);
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = column.id;
                    input.placeholder = `Enter ${column.name.toLowerCase()}`;
                    if (column.required) input.required = true;
                    fieldDiv.appendChild(input);
                }
                
                formFields.appendChild(fieldDiv);
            });
        }

        function editJob(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Job Application';
            document.getElementById('jobId').value = job.id;
            createJobForm();
            
            // Fill form with job data
            columns.forEach(column => {
                const element = document.getElementById(column.id);
                if (element) {
                    element.value = job[column.id] || '';
                }
            });

            const modal = new bootstrap.Modal(document.getElementById('jobModal'));
            modal.show();
        }

        async function saveJob() {
            const form = document.getElementById('jobForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const jobData = {};
            columns.forEach(column => {
                const element = document.getElementById(column.id);
                if (element) {
                    jobData[column.id] = element.value.trim();
                }
            });

            const jobId = document.getElementById('jobId').value;
            const isEdit = jobId !== '';

            try {
                const url = isEdit ? `/api/jobs/${jobId}` : '/api/jobs';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jobData)
                });

                const result = await response.json();

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('jobModal')).hide();
                    await loadJobs();
                    showSuccess(isEdit ? 'Job updated successfully!' : 'Job added successfully!');
                } else {
                    showError(result.error || 'Failed to save job');
                }
            } catch (error) {
                console.error('Error saving job:', error);
                showError('Failed to save job');
            }
        }

        function handleSelectChange(selectElement, fieldName, jobId) {
            const value = selectElement.value;
            
            // Handle custom option selection
            if (value === '__custom__') {
                showCustomInput(selectElement, fieldName, jobId);
                return;
            }

            // Update the job field
            updateJobField(jobId, fieldName, value);
        }

        async function updateJobField(jobId, fieldName, value) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ [fieldName]: value })
                });

                const result = await response.json();
                if (result.success) {
                    await loadJobs();
                    showToast('Field updated successfully!', 'success');
                } else {
                    showToast('Failed to update field', 'error');
                }
            } catch (error) {
                console.error('Error updating field:', error);
                showToast('Failed to update field', 'error');
            }
        }

        function showCustomInput(selectElement, fieldName, jobId) {
            const customInput = document.getElementById(`custom-input-${fieldName}-${jobId}`);
            if (customInput) {
                customInput.style.display = 'block';
                const input = customInput.querySelector('input');
                input.focus();
                
                // Reset the select to empty value
                if (selectElement) {
                    selectElement.value = '';
                }
            }
        }

        function hideCustomInput(fieldName, jobId) {
            const customInput = document.getElementById(`custom-input-${fieldName}-${jobId}`);
            if (customInput) {
                customInput.style.display = 'none';
                const input = customInput.querySelector('input');
                input.value = '';
            }
        }

        function handleCustomInputKeypress(event, fieldName, jobId) {
            if (event.key === 'Enter') {
                addCustomOption(fieldName, jobId);
            } else if (event.key === 'Escape') {
                hideCustomInput(fieldName, jobId);
            }
        }

        async function addCustomOption(fieldName, jobId) {
            const customInput = document.getElementById(`custom-input-${fieldName}-${jobId}`);
            const input = customInput.querySelector('input');
            const newOption = input.value.trim();

            if (!newOption) {
                showToast('Please enter a value', 'error');
                return;
            }

            try {
                // Add the option to the column configuration
                const response = await fetch(`/api/options/${fieldName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ option: newOption })
                });

                const result = await response.json();
                if (result.success) {
                    // Update the job with the new option
                    await updateJobField(jobId, fieldName, newOption);
                    hideCustomInput(fieldName, jobId);
                    showToast('Custom option added and applied!', 'success');
                } else {
                    showToast(result.error || 'Failed to add option', 'error');
                }
            } catch (error) {
                console.error('Error adding custom option:', error);
                showToast('Failed to add custom option', 'error');
            }
        }

        // Form-specific functions for modal
        function showCustomInputForm(selectElement, fieldName) {
            const customInput = document.getElementById(`custom-input-form-${fieldName}`);
            if (customInput) {
                customInput.style.display = 'block';
                const input = customInput.querySelector('input');
                input.focus();
                
                // Reset the select to empty value
                if (selectElement) {
                    selectElement.value = '';
                }
            }
        }

        function hideCustomInputForm(fieldName) {
            const customInput = document.getElementById(`custom-input-form-${fieldName}`);
            if (customInput) {
                customInput.style.display = 'none';
                const input = customInput.querySelector('input');
                input.value = '';
            }
        }

        function handleCustomInputFormKeypress(event, fieldName) {
            if (event.key === 'Enter') {
                addCustomOptionForm(fieldName);
            } else if (event.key === 'Escape') {
                hideCustomInputForm(fieldName);
            }
        }

        async function addCustomOptionForm(fieldName) {
            const customInput = document.getElementById(`custom-input-form-${fieldName}`);
            const input = customInput.querySelector('input');
            const newOption = input.value.trim();

            if (!newOption) {
                showToast('Please enter a value', 'error');
                return;
            }

            try {
                // Add the option to the column configuration
                const response = await fetch(`/api/options/${fieldName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ option: newOption })
                });

                const result = await response.json();
                if (result.success) {
                    // Update the custom dropdown with the new option
                    updateCustomDropdown(fieldName, result.options);
                    
                    // Set the new option as selected
                    selectOption(fieldName, newOption, newOption);
                    
                    hideCustomInputForm(fieldName);
                    showToast('Custom option added!', 'success');
                } else {
                    showToast(result.error || 'Failed to add option', 'error');
                }
            } catch (error) {
                console.error('Error adding custom option:', error);
                showToast('Failed to add custom option', 'error');
            }
        }

        function toggleDropdown(fieldName) {
            const menu = document.getElementById(`menu-${fieldName}`);
            const isVisible = menu.style.display === 'block';
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                m.style.display = 'none';
            });
            
            // Toggle current dropdown
            menu.style.display = isVisible ? 'none' : 'block';
        }

        function selectOption(fieldName, value, text) {
            const button = document.getElementById(`${fieldName}-button`);
            const hiddenInput = document.getElementById(fieldName);
            
            button.textContent = text;
            hiddenInput.value = value;
            
            // Close dropdown
            const menu = document.getElementById(`menu-${fieldName}`);
            menu.style.display = 'none';
        }

        async function deleteOption(fieldName, option, event) {
            event.stopPropagation(); // Prevent dropdown from closing
            
            if (!confirm(`Are you sure you want to delete "${option}"? This will also clear this option from all existing jobs.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/options/${fieldName}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ option: option })
                });

                const result = await response.json();
                if (result.success) {
                    // Update the custom dropdown
                    updateCustomDropdown(fieldName, result.options);
                    showToast(`Option "${option}" deleted successfully!`, 'success');
                } else {
                    showToast(result.error || 'Failed to delete option', 'error');
                }
            } catch (error) {
                console.error('Error deleting option:', error);
                showToast('Failed to delete option', 'error');
            }
        }

        function updateCustomDropdown(fieldName, options) {
            const menu = document.getElementById(`menu-${fieldName}`);
            const defaultOption = menu.querySelector('.dropdown-item:first-child');
            const customOption = menu.querySelector('.dropdown-item.custom-option');
            
            // Clear existing options (keep default and custom)
            menu.innerHTML = '';
            menu.appendChild(defaultOption);
            
            // Add updated options with delete buttons
            options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'dropdown-item option-with-delete';
                optionDiv.innerHTML = `
                    <span>${option}</span>
                    <button class="delete-btn" onclick="deleteOption('${fieldName}', '${option}', event)" title="Delete option">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                optionDiv.onclick = function(e) {
                    if (!e.target.closest('.delete-btn')) {
                        selectOption(fieldName, option, option);
                    }
                };
                menu.appendChild(optionDiv);
            });
            
            menu.appendChild(customOption);
        }

        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job application?')) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    await loadJobs();
                    showSuccess('Job deleted successfully!');
                } else {
                    showError('Failed to delete job');
                }
            } catch (error) {
                console.error('Error deleting job:', error);
                showError('Failed to delete job');
            }
        }

        async function exportToExcel() {
            try {
                window.open('/api/export/excel', '_blank');
                showSuccess('Excel file downloaded successfully!');
            } catch (error) {
                console.error('Error exporting:', error);
                showError('Failed to export Excel file');
            }
        }

        function refreshData() {
            loadJobs();
        }

        function openAddColumnModal() {
            document.getElementById('columnForm').reset();
            document.getElementById('selectOptionsDiv').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('columnModal'));
            modal.show();
        }

        function toggleColumnOptions() {
            const columnType = document.getElementById('columnType').value;
            const optionsDiv = document.getElementById('selectOptionsDiv');
            
            if (columnType === 'select') {
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
        }

        async function saveColumn() {
            const form = document.getElementById('columnForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const columnData = {
                name: document.getElementById('columnName').value.trim(),
                type: document.getElementById('columnType').value,
                required: document.getElementById('columnRequired').checked
            };

            if (columnData.type === 'select') {
                const optionsText = document.getElementById('selectOptions').value;
                columnData.options = optionsText.split('\n').filter(opt => opt.trim());
                columnData.editable = true;
            }

            try {
                const response = await fetch('/api/columns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(columnData)
                });

                const result = await response.json();

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('columnModal')).hide();
                    await loadColumns();
                    showToast('Column added successfully!', 'success');
                } else {
                    showToast(result.error || 'Failed to add column', 'error');
                }
            } catch (error) {
                console.error('Error adding column:', error);
                showToast('Failed to add column', 'error');
            }
        }

        async function resetColumns() {
            if (!confirm('Are you sure you want to reset all columns to defaults? This will remove any custom columns you have added.')) {
                return;
            }

            try {
                const response = await fetch('/api/columns/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    await loadColumns();
                    showToast('Columns reset to defaults successfully!', 'success');
                } else {
                    showToast(result.error || 'Failed to reset columns', 'error');
                }
            } catch (error) {
                console.error('Error resetting columns:', error);
                showToast('Failed to reset columns', 'error');
            }
        }

        async function initColumns() {
            try {
                const response = await fetch('/api/columns/init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    await loadColumns();
                    showToast(result.message, 'success');
                } else {
                    showToast(result.error || 'Failed to initialize columns', 'error');
                }
            } catch (error) {
                console.error('Error initializing columns:', error);
                showToast('Failed to initialize columns', 'error');
            }
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to clear ALL job data? This action cannot be undone and will remove all jobs permanently.')) {
                return;
            }

            try {
                const response = await fetch('/api/clear-all-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    await loadJobs();
                    showToast(result.message, 'success');
                } else {
                    showToast(result.error || 'Failed to clear data', 'error');
                }
            } catch (error) {
                console.error('Error clearing data:', error);
                showToast('Failed to clear data', 'error');
            }
        }

        async function forceRefreshData() {
            try {
                // Clear any cached data
                jobs = [];
                displayJobs();
                
                // Force reload from server
                await loadJobs();
                showToast('Data refreshed from server', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Failed to refresh data', 'error');
            }
        }

        async function syncData() {
            try {
                const response = await fetch('/api/sync-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    await loadJobs();
                    showToast(result.message, 'success');
                } else {
                    showToast(result.error || 'Failed to sync data', 'error');
                }
            } catch (error) {
                console.error('Error syncing data:', error);
                showToast('Failed to sync data', 'error');
            }
        }

        async function checkEnvironmentInfo() {
            try {
                const response = await fetch('/api/environment-info');
                const info = await response.json();
                
                console.log('Environment Info:', info);
                
                if (info.is_vercel) {
                    showToast('Running on Vercel - Data stored in memory', 'warning');
                }
                
                // Show detailed storage info
                const storageInfo = `
                    File Jobs: ${info.file_jobs_count} | 
                    Memory Jobs: ${info.memory_jobs_count} | 
                    Total Jobs: ${info.jobs_count}
                `;
                console.log('Storage Info:', storageInfo);
                
                return info;
            } catch (error) {
                console.error('Error checking environment:', error);
            }
        }

        async function showStorageStatus() {
            try {
                const info = await checkEnvironmentInfo();
                if (info) {
                    const message = `
                        Environment: ${info.is_vercel ? 'Vercel (Serverless)' : 'Local'}
                        File Jobs: ${info.file_jobs_count}
                        Memory Jobs: ${info.memory_jobs_count}
                        Total Jobs: ${info.jobs_count}
                        Columns: ${info.columns_count}
                    `;
                    alert(message);
                }
            } catch (error) {
                console.error('Error showing storage status:', error);
                showToast('Failed to get storage status', 'error');
            }
        }

        function openAddOptionModal(fieldName) {
            currentField = fieldName;
            document.getElementById('newOption').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('optionModal'));
            modal.show();
        }

        async function addOption() {
            const newOption = document.getElementById('newOption').value.trim();
            
            if (!newOption) {
                showToast('Option cannot be empty', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/options/${currentField}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ option: newOption })
                });

                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('optionModal')).hide();
                    await loadColumns();
                    showToast('Option added successfully!', 'success');
                } else {
                    showToast(result.error || 'Failed to add option', 'error');
                }
            } catch (error) {
                console.error('Error adding option:', error);
                showToast('Failed to add option', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.innerHTML = `
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Bulk Update Functions
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const jobCheckboxes = document.querySelectorAll('.job-checkbox');
            
            jobCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.job-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            if (selectedCount > 0) {
                bulkUpdateBtn.style.display = 'inline-block';
                selectedCountSpan.textContent = selectedCount;
            } else {
                bulkUpdateBtn.style.display = 'none';
            }
        }

        function openBulkUpdateModal() {
            const selectedCheckboxes = document.querySelectorAll('.job-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            if (selectedCount === 0) {
                showToast('Please select at least one job to update', 'error');
                return;
            }
            
            document.getElementById('bulkUpdateCount').textContent = selectedCount;
            createBulkUpdateForm();
            
            const modal = new bootstrap.Modal(document.getElementById('bulkUpdateModal'));
            modal.show();
        }

        function createBulkUpdateForm() {
            const fieldsContainer = document.getElementById('bulkUpdateFields');
            fieldsContainer.innerHTML = '';
            
            columns.forEach(column => {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-md-6 mb-3';
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'form-group';
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = column.name;
                fieldDiv.appendChild(label);
                
                if (column.type === 'select') {
                    const selectDiv = document.createElement('div');
                    selectDiv.className = 'editable-select';
                    
                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.id = `bulk-${column.id}`;
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = `Keep current ${column.name}`;
                    select.appendChild(defaultOption);
                    
                    column.options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = option;
                        select.appendChild(optionElement);
                    });
                    
                    selectDiv.appendChild(select);
                    fieldDiv.appendChild(selectDiv);
                } else if (column.type === 'date') {
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.className = 'form-control';
                    input.id = `bulk-${column.id}`;
                    input.placeholder = `Update ${column.name}`;
                    fieldDiv.appendChild(input);
                } else if (column.type === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.className = 'form-control';
                    textarea.id = `bulk-${column.id}`;
                    textarea.rows = 3;
                    textarea.placeholder = `Update ${column.name}`;
                    fieldDiv.appendChild(textarea);
                } else {
                    const input = document.createElement('input');
                    input.type = column.type === 'url' ? 'url' : 'text';
                    input.className = 'form-control';
                    input.id = `bulk-${column.id}`;
                    input.placeholder = `Update ${column.name}`;
                    fieldDiv.appendChild(input);
                }
                
                colDiv.appendChild(fieldDiv);
                fieldsContainer.appendChild(colDiv);
            });
        }

        async function saveBulkUpdate() {
            const selectedCheckboxes = document.querySelectorAll('.job-checkbox:checked');
            const selectedJobIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedJobIds.length === 0) {
                showToast('No jobs selected', 'error');
                return;
            }
            
            // Collect form data
            const updateData = {};
            columns.forEach(column => {
                const field = document.getElementById(`bulk-${column.id}`);
                if (field && field.value.trim() !== '') {
                    updateData[column.id] = field.value.trim();
                }
            });
            
            if (Object.keys(updateData).length === 0) {
                showToast('No changes to update', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/jobs/bulk-update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jobIds: selectedJobIds,
                        updates: updateData
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('bulkUpdateModal')).hide();
                    await loadJobs();
                    showToast(`Successfully updated ${selectedJobIds.length} jobs!`, 'success');
                    
                    // Clear selections
                    document.querySelectorAll('.job-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('selectAllCheckbox').checked = false;
                    updateSelectedCount();
                } else {
                    showToast(result.error || 'Failed to update jobs', 'error');
                }
            } catch (error) {
                console.error('Error updating jobs:', error);
                showToast('Failed to update jobs', 'error');
            }
        }

        async function bulkDeleteJobs() {
            const selectedCheckboxes = document.querySelectorAll('.job-checkbox:checked');
            const selectedJobIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedJobIds.length === 0) {
                showToast('No jobs selected', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedJobIds.length} jobs? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/jobs/bulk-delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jobIds: selectedJobIds
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('bulkUpdateModal')).hide();
                    await loadJobs();
                    showToast(`Successfully deleted ${selectedJobIds.length} jobs!`, 'success');
                    
                    // Clear selections
                    document.querySelectorAll('.job-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('selectAllCheckbox').checked = false;
                    updateSelectedCount();
                } else {
                    showToast(result.error || 'Failed to delete jobs', 'error');
                }
            } catch (error) {
                console.error('Error deleting jobs:', error);
                showToast('Failed to delete jobs', 'error');
            }
        }

        async function sendEmailReminder() {
            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'summary'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Email reminder sent successfully!', 'success');
                } else {
                    showToast(result.error || 'Failed to send email', 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showToast('Failed to send email', 'error');
            }
        }

        async function getSchedulerStatus() {
            try {
                const response = await fetch('/api/scheduler-status');
                const result = await response.json();
                
                if (result.scheduler_running) {
                    console.log('Email scheduler is running');
                    console.log('Scheduled jobs:', result.jobs);
                } else {
                    console.log('Email scheduler is not running');
                    if (result.message) {
                        console.log('Message:', result.message);
                    }
                }
            } catch (error) {
                console.error('Error getting scheduler status:', error);
            }
        }

        // Check scheduler status on page load
        document.addEventListener('DOMContentLoaded', function() {
            getSchedulerStatus();
            
            // Show Vercel notice if running on Vercel
            if (window.location.hostname.includes('vercel.app')) {
                document.getElementById('vercelNotice').style.display = 'block';
            }
        });
    </script>
</body>
</html> 
</html> 